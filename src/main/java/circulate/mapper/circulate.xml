<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="circulate">

	
	<insert id="checkout" parameterType="circulate.dto.CheckoutDTO">
	insert into checkout
	(checkout_id, copy_id, isbn, user_id, checkout_date, due_date) 
	values(checkout_id_seq.nextval, #{copy_id}, #{isbn}, #{user_id}, sysdate, #{due_date})
	</insert>
		
				
	<select id="countCheckouts" parameterType="Long" resultType="java.util.Map">	
	select 
    (select count(*)
	from checkout
  	where user_id = #{user_id} 
    and return_date is null) as checkouts,
    (select count(*)
    from checkout
    where user_id = #{user_id} 
    and return_date is null
    and coalesce(trunc(renewal_date+1),trunc(due_date+1)) <![CDATA[<]]> trunc(sysdate+1)
    ) as late_returns
    from dual	
    </select>
    
    <select id="getReservNum" resultType="int">
    select count(*) from reservation
	where isbn = #{isbn}
	and
	checkout_date is null
	and
	expire_date is null
    </select>


</mapper>